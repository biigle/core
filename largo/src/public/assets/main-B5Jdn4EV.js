import{createElementBlock as d,openBlock as a,resolveComponent as T,createCommentVNode as m,createTextVNode as u,createElementVNode as r,toDisplayString as b,Fragment as O,renderList as L,createBlock as U,createVNode as k,withCtx as K,normalizeClass as g,withDirectives as I,vShow as D,normalizeStyle as M,withModifiers as q,vModelSelect as $}from"vue";const A="imageAnnotation",_="videoAnnotation",C={computed:{id(){return this.image.id},uuid(){return this.image.uuid},type(){return this.image.type},patchPrefix(){return this.uuid[0]+this.uuid[1]+"/"+this.uuid[2]+this.uuid[3]+"/"+this.uuid},urlTemplate(){return biigle.$require("largo.patchUrlTemplate")}},methods:{getThumbnailUrl(){return this.type===_?this.urlTemplate.replace(":prefix",this.patchPrefix).replace(":id",`v-${this.id}`):this.urlTemplate.replace(":prefix",this.patchPrefix).replace(":id",this.id)}},created(){this.type===A?this.showAnnotationRoute=biigle.$require("largo.showImageAnnotationRoute"):this.showAnnotationRoute=biigle.$require("largo.showVideoAnnotationRoute")}},f=(t,e)=>{const i=t.__vccOpts||t;for(const[l,o]of e)i[l]=o;return i},z={mixins:[C],props:{_id:{type:String,required:!0},_uuid:{type:String,required:!0},label:{type:Object,required:!0},emptySrc:{type:String,required:!0},_urlTemplate:{type:String,required:!0}},data(){return{url:""}},computed:{title(){return"Example annotation for label "+this.label.name},src(){return this.url||this.emptySrc},image(){return{id:this._id,uuid:this._uuid,type:A}},urlTemplate(){return this._urlTemplate}},methods:{showEmptyImage(){this.url=""}},created(){this.url=this.getThumbnailUrl()}},H=["src","title"];function W(t,e,i,l,o,n){return a(),d("img",{class:"largo-example-annotation",src:n.src,title:n.title,onError:e[0]||(e[0]=(...s)=>n.showEmptyImage&&n.showEmptyImage(...s))},null,40,H)}const J=f(z,[["render",W]]);let Q=biigle.$require("echo"),v=biigle.$require("events"),E=biigle.$require("handleErrorResponse"),F=biigle.$require("volumes.components.imageGrid"),R=biigle.$require("volumes.components.imageGridImage"),Z=biigle.$require("core.keyboard"),j=biigle.$require("annotations.components.labelsTabPlugins"),X=biigle.$require("labelTrees.components.labelTrees"),Y=biigle.$require("core.mixins.loader"),x=biigle.$require("messages"),N=biigle.$require("core.components.powerToggle"),P=biigle.$require("resource"),ee=biigle.$require("core.models.Settings"),V=biigle.$require("annotations.components.settingsTabPlugins"),te=biigle.$require("core.components.sidebar"),ie=biigle.$require("core.components.sidebarTab");const p=P("api/v1/volumes{/id}/largo",{},{queryImageAnnotations:{method:"GET",url:"api/v1/volumes{/id}/image-annotations/filter/label{/label_id}"},queryVideoAnnotations:{method:"GET",url:"api/v1/volumes{/id}/video-annotations/filter/label{/label_id}"},queryExampleAnnotations:{method:"GET",url:"api/v1/volumes{/id}/image-annotations/examples{/label_id}"},sortAnnotationsByOutlier:{method:"GET",url:"api/v1/volumes{/id}/annotations/sort/outliers{/label_id}"},sortAnnotationsBySimilarity:{method:"GET",url:"api/v1/volumes{/id}/annotations/sort/similarity"},getUsersWithAnnotations:{method:"GET",url:"api/v1/volumes{/id}/users-with-annotations"},fetchVolumeAnnotationLabelCount:{method:"GET",url:"api/v1/volume{/id}/label-count"}}),ne={mixins:[Y],components:{annotationPatch:J},props:{label:{default:null},volumeId:{type:Number,required:!0},count:{type:Number,default:3},emptySrc:{type:String,required:!0},urlTemplate:{type:String,required:!0}},data(){return{exampleLabel:null,exampleAnnotations:[],cache:{},shown:!0}},computed:{isShown(){return this.shown&&this.label!==null},hasExamples(){return this.exampleLabel&&this.exampleAnnotations&&Object.keys(this.exampleAnnotations).length>0}},methods:{parseResponse(t){return t.data},setExampleAnnotations(t){(!t[0].hasOwnProperty("annotations")||Object.keys(t[0].annotations).length<this.count)&&delete this.cache[t[1]],(!t[0].hasOwnProperty("label")||t[0].label.id!==t[1])&&delete this.cache[t[1]],this.label&&this.label.id===t[1]&&(this.exampleAnnotations=t[0].annotations,this.exampleLabel=t[0].label)},updateShown(t){this.shown=t},updateExampleAnnotations(){this.exampleAnnotations=[],this.isShown&&(this.startLoading(),this.cache.hasOwnProperty(this.label.id)||(this.cache[this.label.id]=p.queryExampleAnnotations({id:this.volumeId,label_id:this.label.id,take:this.count}).then(this.parseResponse)),Promise.all([this.cache[this.label.id],this.label.id]).then(this.setExampleAnnotations).finally(this.finishLoading))}},watch:{label(){this.updateExampleAnnotations()},shown(){this.updateExampleAnnotations()}},created(){v.on("settings.exampleAnnotations",this.updateShown)}},se={key:0,class:"largo-example-annotations"},oe={key:0,class:"text-muted"},le={key:1},re={key:0},ae={key:0,class:"text-muted"},de=["textContent"],ue=["textContent"],he={class:"largo-example-annotations__images"},me={key:1,class:"text-muted"};function ce(t,e,i,l,o,n){const s=T("annotation-patch");return n.isShown?(a(),d("div",se,[t.loading?(a(),d("p",oe,`
        Loading example annotations...
    `)):(a(),d("div",le,[n.hasExamples?(a(),d("div",re,[i.label.id!==o.exampleLabel.id?(a(),d("p",ae,[e[0]||(e[0]=u(`
                Examples with label `)),r("strong",{textContent:b(o.exampleLabel.name)},null,8,de),e[1]||(e[1]=u(", may be similar to ")),r("strong",{textContent:b(i.label.name)},null,8,ue),e[2]||(e[2]=u(`:
            `))])):m("",!0),e[3]||(e[3]=u()),r("div",he,[(a(!0),d(O,null,L(o.exampleAnnotations,(c,w)=>(a(),U(s,{key:w,_id:w,_uuid:c,label:i.label,"empty-src":i.emptySrc,"_url-template":i.urlTemplate},null,8,["_id","_uuid","label","empty-src","_url-template"]))),128))])])):(a(),d("p",me,`
            No example annotations available.
        `))]))])):m("",!0)}const ge=f(ne,[["render",ce]]);j&&(j.exampleAnnotations=ge);const fe={components:{powerButton:N},props:{settings:{type:Object,required:!0}},data(){return{isShown:!0}},methods:{hide(){this.isShown=!1,this.settings.set("exampleAnnotations",!1)},show(){this.isShown=!0,this.settings.delete("exampleAnnotations")}},watch:{isShown(t){v.emit("settings.exampleAnnotations",t)}},created(){this.settings.has("exampleAnnotations")&&(this.isShown=this.settings.get("exampleAnnotations"))}},be={class:"sidebar-tab__section"};function pe(t,e,i,l,o,n){const s=T("power-button");return a(),d("div",be,[k(s,{active:o.isShown,"title-off":"Show example annotations","title-on":"Hide example annotations",onOn:n.show,onOff:n.hide},{default:K(()=>e[0]||(e[0]=[u(`
                Example Annotations
            `)])),_:1},8,["active","onOn","onOff"])])}const ye=f(fe,[["render",pe]]);V&&(V.exampleAnnotations=ye);biigle.$declare("largo.mixins.annotationPatch",C);const ve={mixins:[R,C],data(){return{showAnnotationRoute:null,overlayIsLoaded:!1,overlayHasError:!1}},inject:["outlines"],computed:{showAnnotationLink(){return this.showAnnotationRoute?this.showAnnotationRoute+this.image.id:""},svgSrcUrl(){return this.srcUrl.replace(/.[A-Za-z]*$/,".svg")},showOutlines(){return!this.overlayHasError&&this.outlines.showAnnotationOutlines}},methods:{handleOverlayLoad(){this.overlayIsLoaded=!0},handleOverlayError(){this.overlayHasError=!0}},created(){this.type===A?this.showAnnotationRoute=biigle.$require("annotationCatalog.showImageAnnotationRoute"):this.showAnnotationRoute=biigle.$require("annotationCatalog.showVideoAnnotationRoute")}},Se=["href"],Ae=["src"],Ie=["src"],we=["src"];function _e(t,e,i,l,o,n){return a(),d("figure",{class:g(["image-grid__image image-grid__image--catalog",t.classObject])},[n.showAnnotationLink?(a(),d("a",{key:0,href:n.showAnnotationLink,target:"_blank",title:"Show the annotation in the annotation tool"},[r("img",{src:t.srcUrl,onError:e[0]||(e[0]=(...s)=>t.showEmptyImage&&t.showEmptyImage(...s))},null,40,Ae),e[4]||(e[4]=u()),this.showOutlines?I((a(),d("img",{key:0,src:n.svgSrcUrl,onError:e[1]||(e[1]=(...s)=>n.handleOverlayError&&n.handleOverlayError(...s)),onLoad:e[2]||(e[2]=(...s)=>n.handleOverlayLoad&&n.handleOverlayLoad(...s)),class:"outlines"},null,40,Ie)),[[D,o.overlayIsLoaded]]):m("",!0)],8,Se)):(a(),d("img",{key:1,src:t.srcUrl,onError:e[3]||(e[3]=(...s)=>t.showEmptyImage&&t.showEmptyImage(...s))},null,40,we))],2)}const Oe=f(ve,[["render",_e]]),Le={mixins:[F],components:{imageGridImage:Oe}},G=P("api/v1/labels{/id}",{},{queryImageAnnotations:{method:"GET",url:"api/v1/labels{/id}/image-annotations"},queryVideoAnnotations:{method:"GET",url:"api/v1/labels{/id}/video-annotations"}}),Te={mixins:[R,C],data(){return{showAnnotationRoute:null,overlayIsLoaded:!1,overlayHasError:!1}},inject:["outlines"],computed:{showAnnotationLink(){return this.showAnnotationRoute?this.showAnnotationRoute+this.image.id:""},selected(){return this.image.dismissed},title(){return this.selected?"Undo dismissing this annotation":"Dismiss this annotation"},pinTitle(){return this.isPinned?"Reset sorting":"Select as reference (sort by similarity)"},svgSrcUrl(){return this.srcUrl.replace(/.[A-Za-z]*$/,".svg")},showAnnotationOutlines(){return!this.overlayHasError&&this.outlines.showAnnotationOutlines}},methods:{handleOverlayLoad(){this.overlayIsLoaded=!0},handleOverlayError(){this.overlayHasError=!0}}},Ce=["title"],Ee={key:0,class:"image-icon"},$e=["src"],qe=["src"],xe={key:2,class:"image-buttons-bottom"},ke=["title"],De={key:3,class:"image-buttons"},Fe=["href"];function Re(t,e,i,l,o,n){return a(),d("figure",{class:g(["image-grid__image image-grid__image--largo",t.classObject]),title:n.title},[t.selectable?(a(),d("div",Ee,[r("i",{class:g(["fas",t.iconClass])},null,2)])):m("",!0),e[7]||(e[7]=u()),r("img",{src:t.srcUrl,onError:e[0]||(e[0]=(...s)=>t.showEmptyImage&&t.showEmptyImage(...s)),onClick:e[1]||(e[1]=(...s)=>t.toggleSelect&&t.toggleSelect(...s))},null,40,$e),e[8]||(e[8]=u()),this.showAnnotationOutlines?I((a(),d("img",{key:1,src:n.svgSrcUrl,onError:e[2]||(e[2]=(...s)=>n.handleOverlayError&&n.handleOverlayError(...s)),onLoad:e[3]||(e[3]=(...s)=>n.handleOverlayLoad&&n.handleOverlayLoad(...s)),class:"outlines"},null,40,qe)),[[D,o.overlayIsLoaded]]):m("",!0),e[9]||(e[9]=u()),t.pinnable||t.isPinned?(a(),d("div",xe,[r("button",{class:"image-button image-button__pin",onClick:e[4]||(e[4]=(...s)=>t.emitPin&&t.emitPin(...s)),title:n.pinTitle},e[5]||(e[5]=[r("span",{class:"fa fa-thumbtack fa-fw"},null,-1)]),8,ke)])):m("",!0),e[10]||(e[10]=u()),n.showAnnotationLink?(a(),d("div",De,[r("a",{href:n.showAnnotationLink,target:"_blank",class:"image-button",title:"Show the annotation in the annotation tool"},e[6]||(e[6]=[r("span",{class:"fa fa-external-link-square-alt fa-fw","aria-hidden":"true"},null,-1)]),8,Fe)])):m("",!0)],10,Ce)}const Ne=f(Te,[["render",Re]]),Pe={mixins:[F],components:{imageGridImage:Ne}},Be={mixins:[R,C],data(){return{showAnnotationRoute:null,overlayIsLoaded:!1,overlayHasError:!1}},inject:["outlines"],computed:{showAnnotationLink(){return this.showAnnotationRoute?this.showAnnotationRoute+this.image.id:""},selected(){return this.image.newLabel},title(){return this.selected?"Revert changing the label of this annotation":"Change the label of this annotation"},newLabelStyle(){return{"background-color":"#"+this.image.newLabel.color}},svgSrcUrl(){return this.srcUrl.replace(/.[A-Za-z]*$/,".svg")},showAnnotationOutlines(){return!this.overlayHasError&&this.outlines.showAnnotationOutlines}},methods:{handleOverlayLoad(){this.overlayIsLoaded=!0},handleOverlayError(){this.overlayHasError=!0}}},je=["title"],Ve={key:0,class:"image-icon"},Ge=["src"],Ue=["src"],Ke={key:2,class:"image-buttons"},Me=["href"],Ye={key:3,class:"new-label"},ze=["textContent"];function He(t,e,i,l,o,n){return a(),d("figure",{class:g(["image-grid__image image-grid__image--largo image-grid__image--relabel",t.classObject]),title:n.title},[t.selectable?(a(),d("div",Ve,[r("i",{class:g(["fas",t.iconClass])},null,2)])):m("",!0),e[6]||(e[6]=u()),r("img",{onClick:e[0]||(e[0]=(...s)=>t.toggleSelect&&t.toggleSelect(...s)),src:t.srcUrl,onError:e[1]||(e[1]=(...s)=>t.showEmptyImage&&t.showEmptyImage(...s))},null,40,Ge),e[7]||(e[7]=u()),this.showAnnotationOutlines?I((a(),d("img",{key:1,src:n.svgSrcUrl,onError:e[2]||(e[2]=(...s)=>n.handleOverlayError&&n.handleOverlayError(...s)),onLoad:e[3]||(e[3]=(...s)=>n.handleOverlayLoad&&n.handleOverlayLoad(...s)),class:"outlines"},null,40,Ue)),[[D,o.overlayIsLoaded]]):m("",!0),e[8]||(e[8]=u()),n.showAnnotationLink?(a(),d("div",Ke,[r("a",{href:n.showAnnotationLink,target:"_blank",class:"image-button",title:"Show the annotation in the annotation tool"},e[4]||(e[4]=[r("span",{class:"fa fa-external-link-square-alt","aria-hidden":"true"},null,-1)]),8,Me)])):m("",!0),e[9]||(e[9]=u()),n.selected?(a(),d("div",Ye,[r("span",{class:"new-label__color",style:M(n.newLabelStyle)},null,4),e[5]||(e[5]=u()),r("span",{class:"new-label__name",textContent:b(t.image.newLabel.name)},null,8,ze)])):m("",!0)],10,je)}const We=f(Be,[["render",He]]),Je={mixins:[F],components:{imageGridImage:We}};let Qe={showOutlines:!0};const Ze=new ee({storageKey:"biigle.largo.settings",defaults:Qe}),Xe={emits:["change-outlines"],components:{PowerToggle:N},data(){return{restoreKeys:["showOutlines"],showOutlines:!0}},computed:{settings(){return Ze}},methods:{enableOutlines(){this.showOutlines=!0},disableOutlines(){this.showOutlines=!1}},watch:{showOutlines(t){this.$emit("change-outlines",t),this.settings.set("showOutlines",t)}},created(){this.restoreKeys.forEach(t=>{this[t]=this.settings.get(t)}),Z.on("o",()=>{this.showOutlines?this.disableOutlines():this.enableOutlines()})}},et={class:"settings-tab"},tt={class:"largo-tab__button"};function it(t,e,i,l,o,n){const s=T("power-toggle");return a(),d("div",et,[r("div",tt,[k(s,{active:o.showOutlines,onOn:n.enableOutlines,onOff:n.disableOutlines},{default:K(()=>e[0]||(e[0]=[u(`
                Show annotation outlines
            `)])),_:1},8,["active","onOn","onOff"])])])}const nt=f(Xe,[["render",it]]),y={ASCENDING:0,DESCENDING:1},h={ANNOTATION_ID:0,OUTLIER:1,SIMILARITY:2},st={emits:["change-direction","change-key","init-similarity","cancel-similarity"],props:{sortKey:{type:Number,required:!0},sortDirection:{type:Number,required:!0},needsSimilarityReference:{type:Boolean,default:!1}},computed:{sortedAscending(){return this.sortDirection===y.ASCENDING},sortedDescending(){return this.sortDirection===y.DESCENDING},sortingByAnnotationId(){return this.sortKey===h.ANNOTATION_ID},sortingByOutlier(){return this.sortKey===h.OUTLIER},sortingBySimilarity(){return this.sortKey===h.SIMILARITY}},methods:{sortAscending(){this.$emit("change-direction",y.ASCENDING)},sortDescending(){this.$emit("change-direction",y.DESCENDING)},reset(){this.sortDescending(),this.sortByAnnotationId()},sortByAnnotationId(){this.$emit("change-key",h.ANNOTATION_ID),this.needsSimilarityReference&&this.cancelSortBySimilarity()},sortByOutlier(){this.$emit("change-key",h.OUTLIER),this.needsSimilarityReference&&this.cancelSortBySimilarity()},initializeSortBySimilarity(){this.$emit("init-similarity")},cancelSortBySimilarity(){this.$emit("cancel-similarity")}}},ot={class:"sorting-tab"},lt={class:"sorting-tab__buttons"},rt={class:"btn-group",role:"group"},at={class:"btn-group pull-right",role:"group"},dt={class:"list-group sorter-list-group"},ut={key:1};function ht(t,e,i,l,o,n){return a(),d("div",ot,[r("div",lt,[r("div",rt,[r("button",{type:"button",class:g(["btn btn-default",{active:n.sortedDescending}]),title:"Sort descending",onClick:e[0]||(e[0]=(...s)=>n.sortDescending&&n.sortDescending(...s))},e[7]||(e[7]=[r("span",{class:"fa fa-sort-amount-down"},null,-1)]),2),e[9]||(e[9]=u()),r("button",{type:"button",class:g(["btn btn-default",{active:n.sortedAscending}]),title:"Sort ascending",onClick:e[1]||(e[1]=(...s)=>n.sortAscending&&n.sortAscending(...s))},e[8]||(e[8]=[r("span",{class:"fa fa-sort-amount-up"},null,-1)]),2)]),e[11]||(e[11]=u()),r("div",at,[r("button",{type:"button",class:"btn btn-default",title:"Reset sorting",onClick:e[2]||(e[2]=(...s)=>n.reset&&n.reset(...s))},e[10]||(e[10]=[r("span",{class:"fa fa-times"},null,-1)]))])]),e[17]||(e[17]=u()),r("div",dt,[r("button",{class:g(["list-group-item",{active:n.sortingByAnnotationId}]),title:"Sort by annotation timestamp (higher is newer)",onClick:e[3]||(e[3]=(...s)=>n.sortByAnnotationId&&n.sortByAnnotationId(...s))},`
                Created
            `,2),e[15]||(e[15]=u()),r("button",{class:g(["list-group-item",{active:n.sortingByOutlier}]),title:"Sort by outliers (higher is more dissimilar)",onClick:e[4]||(e[4]=(...s)=>n.sortByOutlier&&n.sortByOutlier(...s))},`
                Outliers
            `,2),e[16]||(e[16]=u()),r("a",{class:g(["list-group-item",{active:n.sortingBySimilarity,"list-group-item-warning":i.needsSimilarityReference}]),title:"Sort by similarity (higher is more similar)",href:"#",onClick:e[6]||(e[6]=q((...s)=>n.initializeSortBySimilarity&&n.initializeSortBySimilarity(...s),["prevent"]))},[i.needsSimilarityReference?(a(),d("button",{key:0,class:"btn btn-default btn-xs pull-right",title:"Cancel selecting a reference annotation",onClick:e[5]||(e[5]=q((...s)=>n.cancelSortBySimilarity&&n.cancelSortBySimilarity(...s),["stop"]))},e[12]||(e[12]=[r("i",{class:"fa fa-undo"},null,-1)]))):m("",!0),e[14]||(e[14]=u(`
                Similarity
                `)),i.needsSimilarityReference?(a(),d("p",ut,e[13]||(e[13]=[u(`
                    Select a reference annotation with a click on the `),r("i",{class:"fa fa-thumbtack fa-fw"},null,-1),u(` button.
                `)]))):m("",!0)],2)])])}const mt=f(st,[["render",ht]]),S=P("api/v1/projects{/id}/largo",{},{queryImageAnnotations:{method:"GET",url:"api/v1/projects{/id}/image-annotations/filter/label{/label_id}"},queryVideoAnnotations:{method:"GET",url:"api/v1/projects{/id}/video-annotations/filter/label{/label_id}"},sortAnnotationsByOutlier:{method:"GET",url:"api/v1/projects{/id}/annotations/sort/outliers{/label_id}"},sortAnnotationsBySimilarity:{method:"GET",url:"api/v1/projects{/id}/annotations/sort/similarity"},getUsersWithAnnotations:{method:"GET",url:"api/v1/projects{/id}/users-with-annotations"},fetchProjectAnnotationLabelCount:{method:"GET",url:"api/v1/projects{/id}/label-count"}}),ct={emits:["set-union-logic","reset-filters","add-filter"],props:{union:{type:Boolean,required:!0}},data(){return{filterValues:{Shape:biigle.$require("largo.availableShapes"),User:{}},filterToKeyMapping:{Shape:"shape_id",User:"user_id"},selectedFilter:"Shape",selectedFilterValue:null,negate:!1}},computed:{activeFilterValue(){return this.filterValues[this.selectedFilter]}},methods:{activateAndOperator(){this.$emit("set-union-logic",!1)},activateOrOperator(){this.$emit("set-union-logic",!0)},reset(){this.$emit("reset-filters")},resetSelectedFilter(){this.selectedFilterValue=null},loadApiFilters(){let t=biigle.$require("largo.volumeId"),e;if(typeof t=="number")e=p.getUsersWithAnnotations({id:t});else{let i=biigle.$require("largo.projectId");e=S.getUsersWithAnnotations({id:i})}e.then(i=>i.data.forEach(l=>this.filterValues.User[l.user_id]=l.name),x.handleErrorResponse)},addFilter(){if(!this.selectedFilterValue)return;let t,e=[...this.selectedFilterValue];e[1]=+e[1],this.negate?(t="is not",e[1]>0&&(e[1]=-e[1])):t="is";let i={name:this.selectedFilter+" "+t+" "+e[0],filter:this.filterToKeyMapping[this.selectedFilter],value:e[1]};this.$emit("add-filter",i)}}},gt={class:"annotation-filter"},ft={class:"form-group"},bt={class:"btn-group",role:"group"},pt={class:"btn-group pull-right",role:"group"},yt={class:"filter-form__selects"},vt={class:"form-group largo-filter-select"},St=["value","textContent"],At={class:"form-group largo-filter-select filter-select"},It={class:"filter-form__selects"},wt={class:"form-group largo-filter-select"},_t=["value","textContent"],Ot={class:"form-group filter-select largo-filter-select"},Lt=["disabled"];function Tt(t,e,i,l,o,n){return a(),d("div",gt,[r("div",ft,[r("div",bt,[r("button",{type:"button",class:g(["btn btn-default",{active:!i.union}]),title:"Use the 'and' operator for filter rules",onClick:e[0]||(e[0]=(...s)=>n.activateAndOperator&&n.activateAndOperator(...s))},`
                    and
                `,2),e[9]||(e[9]=u()),r("button",{type:"button",class:g(["btn btn-default",{active:i.union}]),title:"Use the 'or' operator for filter rules",onClick:e[1]||(e[1]=(...s)=>n.activateOrOperator&&n.activateOrOperator(...s))},`
                    or
                `,2)]),e[11]||(e[11]=u()),r("div",pt,[r("button",{type:"button",class:"btn btn-default",title:"Clear all filter rules",onClick:e[2]||(e[2]=(...s)=>n.reset&&n.reset(...s))},e[10]||(e[10]=[r("span",{class:"fa fa-times","aria-hidden":"true"},null,-1)]))])]),e[15]||(e[15]=u()),r("div",yt,[r("div",vt,[I(r("select",{class:"form-control",selected:"Shapes","onUpdate:modelValue":e[3]||(e[3]=s=>o.selectedFilter=s),title:"Select attribute for filtering",onClickOnce:e[4]||(e[4]=(...s)=>n.loadApiFilters&&n.loadApiFilters(...s)),onChange:e[5]||(e[5]=(...s)=>n.resetSelectedFilter&&n.resetSelectedFilter(...s))},[(a(!0),d(O,null,L(Object.keys(o.filterValues),s=>(a(),d("option",{value:s,textContent:b(s)},null,8,St))),256))],544),[[$,o.selectedFilter]])]),e[13]||(e[13]=u()),r("div",At,[I(r("select",{class:"form-control","onUpdate:modelValue":e[6]||(e[6]=s=>o.negate=s),selected:"true",required:""},e[12]||(e[12]=[r("option",{value:!1},"is",-1),u(),r("option",{value:!0},"is not",-1)]),512),[[$,o.negate]])])]),e[16]||(e[16]=u()),r("div",It,[r("div",wt,[I(r("select",{class:"form-control","onUpdate:modelValue":e[7]||(e[7]=s=>o.selectedFilterValue=s)},[(a(!0),d(O,null,L(n.activeFilterValue,(s,c)=>(a(),d("option",{value:[s,c],textContent:b(s)},null,8,_t))),256))],512),[[$,o.selectedFilterValue]])]),e[14]||(e[14]=u()),r("div",Ot,[r("button",{type:"button",disabled:!o.selectedFilterValue||null,class:"btn btn-default btn-block",title:"Add the selected filter rule",onClick:e[8]||(e[8]=(...s)=>n.addFilter&&n.addFilter(...s))},`
                    Add rule
                `,8,Lt)])])])}const Ct=f(ct,[["render",Tt]]),Et={emits:["remove-filter"],components:{AnnotationFilter:Ct},props:{activeFilters:{type:Array,required:!0},union:{type:Boolean,required:!0}},computed:{logicString(){return this.union?"or":"and"}},methods:{removeFilter(t){this.$emit("remove-filter",t)}}},$t={class:"filtering-tab"},qt={class:"list-group"},xt={key:0,class:"list-group-item text-muted"},kt={class:"list-group-item"},Dt={key:0},Ft=["onClick"];function Rt(t,e,i,l,o,n){const s=T("annotation-filter");return a(),d("div",$t,[r("form",{class:"form clearfix",onSubmit:e[3]||(e[3]=q(()=>{},["prevent"]))},[k(s,{union:i.union,onAddFilter:e[0]||(e[0]=c=>t.$emit("add-filter",c)),onSetUnionLogic:e[1]||(e[1]=c=>t.$emit("set-union-logic",c)),onResetFilters:e[2]||(e[2]=c=>t.$emit("reset-filters"))},null,8,["union"])],32),e[8]||(e[8]=u()),r("ul",qt,[i.activeFilters.length==0?(a(),d("li",xt,`
                No filter rules
            `)):m("",!0),e[7]||(e[7]=u()),(a(!0),d(O,null,L(i.activeFilters,(c,w)=>(a(),d("li",kt,[w>0?(a(),d("span",Dt,b(n.logicString),1)):m("",!0),e[5]||(e[5]=u()),r("span",null,b(c.name),1),e[6]||(e[6]=u()),r("button",{onClick:ii=>n.removeFilter(w),type:"button",class:"close",title:"Remove this filter rule"},e[4]||(e[4]=[r("span",{"aria-hidden":"true"},"Ã—",-1)]),8,Ft)]))),256))])])}const Nt=f(Et,[["render",Rt]]),Pt={emits:["select","deselect"],props:{label:{type:Object,default(){return{}}}},computed:{title(){return`Annotations with label ${this.label.name}`},classObject(){return{selected:this.label.selected}},countTitle(){return`There are ${this.count} annotations with label ${this.label.name}`},colorStyle(){return"background-color: #"+this.label.color},count(){return this.label.count}},methods:{emitSelectLabel(){this.labelItem.selected=!this.labelItem.selected,this.labelItem.selected?this.$emit("select",this.labelItem):this.$emit("deselect")}},created(){this.labelItem=this.label}},Bt=["title"],jt=["textContent","title"],Vt=["textContent"];function Gt(t,e,i,l,o,n){return a(),d("li",{class:g(["annotations-tab-item--largo",n.classObject]),title:n.title},[r("div",{class:"annotations-tab-item__title--largo",onClick:e[0]||(e[0]=(...s)=>n.emitSelectLabel&&n.emitSelectLabel(...s))},[r("span",{class:"pull-right badge",textContent:b(n.count),title:n.countTitle},null,8,jt),e[1]||(e[1]=u()),r("span",{class:"annotations-tab-item__color--largo",style:M(n.colorStyle)},null,4),e[2]||(e[2]=u()),r("span",{textContent:b(i.label.name)},null,8,Vt)])],10,Bt)}const Ut=f(Pt,[["render",Gt]]),Kt={emits:["select","deselect"],components:{labelItem:Ut},props:{labels:{type:Array,default(){return[]}}},computed:{annotationBadgeCount(){return this.labels.reduce((t,e)=>t+e.count,0)}},methods:{handleSelectedLabel(t){this.$emit("select",t)},handleDeselectedLabel(){this.$emit("deselect")}}},Mt={class:"annotations-tab--largo"},Yt={class:"annotations-tab__header--largo"},zt={class:"text-muted"},Ht=["textContent"],Wt={class:"annotations-tab__list--largo list-unstyled",ref:"scrollList"};function Jt(t,e,i,l,o,n){const s=T("label-item");return a(),d("div",Mt,[r("div",Yt,[r("div",zt,[e[0]||(e[0]=u(`Total
                `)),r("span",{class:"pull-right badge",textContent:b(n.annotationBadgeCount)},null,8,Ht)])]),e[1]||(e[1]=u()),r("ul",Wt,[(a(!0),d(O,null,L(i.labels,c=>(a(),U(s,{key:c.id,label:c,onSelect:n.handleSelectedLabel,onDeselect:n.handleDeselectedLabel},null,8,["label","onSelect","onDeselect"]))),128))],512)])}const Qt=f(Kt,[["render",Jt]]),B={mixins:[Y],components:{labelTrees:X,sidebar:te,sidebarTab:ie,powerToggle:N,dismissImageGrid:Pe,relabelImageGrid:Je,settingsTab:nt,sortingTab:mt,filteringTab:Nt,labelList:Qt},data(){return{user:null,labelTrees:[],step:0,selectedLabel:null,annotationsCache:{},lastSelectedImage:null,forceChange:!1,waitForSessionId:null,showAnnotationOutlines:!0,sortingSequenceCache:{},sortingSequence:[],sortingDirection:y.DESCENDING,sortingKey:h.ANNOTATION_ID,needsSimilarityReference:!1,similarityReference:null,pinnedImage:null,activeFilters:[],union:!1,labels:[],filtersCache:{},fetchedLabelCount:!1}},provide(){const t={};return Object.defineProperty(t,"showAnnotationOutlines",{get:()=>this.showAnnotationOutlines}),{outlines:t}},computed:{isInDismissStep(){return this.step===0},isInRelabelStep(){return this.step===1},annotations(){if(!this.selectedLabel||this.loading)return[];if(this.annotationsCache.hasOwnProperty(this.selectedLabel.id)){let t=this.annotationsCache[this.selectedLabel.id],e=JSON.stringify({...this.activeFilters,label:this.selectedLabel.id,union:this.union});if(this.hasActiveFilters){if(!this.filtersCache.hasOwnProperty(e))return[];t=t.filter(i=>this.filtersCache[e].get(i.id))}return t}return[]},annotationsCount(){return this.annotations.length},sortedAnnotations(){let t=this.annotations;if(t.length===0)return t;if(this.sortingKey!==h.ANNOTATION_ID){const e={};t.forEach(i=>{e[i.type===_?"v"+i.id:"i"+i.id]=i}),t=this.sortingSequence.map(i=>e[i]).filter(i=>i!==void 0)}return this.sortingDirection===y.ASCENDING?t.slice().reverse():t},allAnnotations(){let t=[];for(let e in this.annotationsCache)this.annotationsCache.hasOwnProperty(e)&&(t=t.concat(this.annotationsCache[e]));return t},hasNoAnnotations(){return this.selectedLabel&&!this.loading&&this.annotations.length===0},dismissedAnnotations(){return this.allAnnotations.filter(t=>t.dismissed)},dismissedAnnotationsCount(){return this.dismissedAnnotations.length},annotationsWithNewLabel(){return this.dismissedAnnotations.filter(t=>!!t.newLabel)},hasDismissedAnnotations(){return this.dismissedAnnotations.length>0},dismissedImageAnnotationsToSave(){return this.packDismissedToSave(this.dismissedAnnotations.filter(t=>t.type===A))},dismissedVideoAnnotationsToSave(){return this.packDismissedToSave(this.dismissedAnnotations.filter(t=>t.type===_))},changedImageAnnotationsToSave(){return this.packChangedToSave(this.annotationsWithNewLabel.filter(t=>t.type===A))},changedVideoAnnotationsToSave(){return this.packChangedToSave(this.annotationsWithNewLabel.filter(t=>t.type===_))},toDeleteCount(){return this.dismissedAnnotations.length-this.annotationsWithNewLabel.length},saveButtonClass(){return this.forceChange?"btn-danger":"btn-success"},sortingIsActive(){return this.isInDismissStep&&(this.sortingKey!==h.ANNOTATION_ID||this.sortingDirection!==y.DESCENDING)},imagesPinnable(){return this.needsSimilarityReference||this.sortingKey===h.SIMILARITY},labelTreesIndex(){let t={};return this.labelTrees.forEach((e,i)=>{t[e.id]={index:i,labels:{}},e.labels.forEach((l,o)=>{t[e.id].labels[l.id]=o})}),t},pinnedImageInAnnotations(){return this.annotations.includes(this.pinnedImage)},hasActiveFilters(){return this.activeFilters.length>0}},methods:{compileFilters(t,e){let i=[];return t.forEach(l=>{i[l.filter]||(i[l.filter]=[]),i[l.filter].push(l.value)}),i.union=e?1:0,i},getAnnotations(t){let e,i,l,o=this.union,n=this.activeFilters;if(this.annotationsCache.hasOwnProperty(t.id)?e=Promise.resolve():(this.annotationsCache[t.id]=[],this.startLoading(),e=this.queryAnnotations(t).then(s=>this.gotAnnotations(t,s),E).then(s=>this.annotationsCache[t.id]=s)),this.sortingKey===h.SIMILARITY?i=this.resetSorting():this.sortingIsActive?(this.sortingSequence=[],i=this.updateSortKey(this.sortingKey)):i=Promise.resolve(),n.length>0){let s=JSON.stringify({...n,label:t.id,union:o});this.filtersCache.hasOwnProperty(s)||(this.loading||this.startLoading(),l=this.loadFilters(t,n,o,s))}Promise.all([e,i,l]).finally(this.finishLoading)},gotAnnotations(t,e){let i=e[0].data,l=e[1].data,o=[];return i&&(o=o.concat(this.initAnnotations(t,i,A))),l&&(o=o.concat(this.initAnnotations(t,l,_))),o=o.sort((n,s)=>s.id-n.id),o},removeFilter(t){this.activeFilters.splice(t,1)},handleSelectedFilters(){let t=this.activeFilters,e=this.union,i=this.selectedLabel;if(!i)return[];let l=JSON.stringify({...t,label:i.id,union:e});this.filtersCache.hasOwnProperty(l)||(this.startLoading(),this.loadFilters(i,t,e,l).finally(this.finishLoading))},loadFilters(t,e,i,l){let o=this.compileFilters(e,i);return this.queryAnnotations(t,o).then(n=>this.gotAnnotations(t,n),E).then(n=>n.map(s=>[s.id,!0])).then(n=>new Map(n)).then(n=>this.filtersCache[l]=n)},initAnnotations(t,e,i){return Object.keys(e).map(function(l){return{id:l,uuid:e[l],label_id:t.id,dismissed:!1,newLabel:null,type:i}})},handleSelectedLabel(t){this.selectedLabel=t,this.isInDismissStep&&this.getAnnotations(t)},handleDeselectedLabel(){this.selectedLabel=null},handleSelectedImageDismiss(t,e){t.dismissed?(t.dismissed=!1,t.newLabel=null):(t.dismissed=!0,e.shiftKey&&this.lastSelectedImage?this.dismissAllImagesBetween(t,this.lastSelectedImage):this.lastSelectedImage=t)},goToRelabel(){this.step=1,this.lastSelectedImage=null,this.resetFilteringTab()},goToDismiss(){this.step=0,this.lastSelectedImage=null,this.selectedLabel&&this.getAnnotations(this.selectedLabel)},handleSelectedImageRelabel(t,e){t.newLabel?this.selectedLabel&&t.newLabel.id!==this.selectedLabel.id?t.newLabel=this.selectedLabel:t.newLabel=null:this.selectedLabel&&(t.newLabel=this.selectedLabel,e.shiftKey&&this.lastSelectedImage?this.relabelAllImagesBetween(t,this.lastSelectedImage):this.lastSelectedImage=t)},save(){if(!this.loading){if(this.toDeleteCount>0){let t;for(;t!==null&&parseInt(t,10)!==this.toDeleteCount;)t=prompt(`This might delete ${this.toDeleteCount} annotation(s). Please enter the number to continue.`);if(t===null)return}this.startLoading(),this.performSave({dismissed_image_annotations:this.dismissedImageAnnotationsToSave,changed_image_annotations:this.changedImageAnnotationsToSave,dismissed_video_annotations:this.dismissedVideoAnnotationsToSave,changed_video_annotations:this.changedVideoAnnotationsToSave,force:this.forceChange}).then(t=>{this.waitForSessionId=t.body.id,this.resetLabelCount()},t=>{this.finishLoading(),E(t)})}},handleSessionSaved(t){if(t.id==this.waitForSessionId){this.finishLoading(),x.success("Saved. You can now start a new re-evaluation session."),this.step=0;for(let e in this.annotationsCache)this.annotationsCache.hasOwnProperty(e)&&delete this.annotationsCache[e];for(let e in this.sortingSequenceCache)this.sortingSequenceCache.hasOwnProperty(e)&&delete this.sortingSequenceCache[e];this.handleSelectedLabel(this.selectedLabel)}},handleSessionFailed(t){t.id==this.waitForSessionId&&(this.finishLoading(),x.danger("There was an unexpected error."))},dismissAllImagesBetween(t,e){let i=this.sortedAnnotations.indexOf(t),l=this.sortedAnnotations.indexOf(e);if(l<i){let o=l;l=i,i=o}for(let o=i+1;o<l;o++)this.sortedAnnotations[o].dismissed=!0},relabelAllImagesBetween(t,e){let i=this.selectedLabel,l=this.allAnnotations.indexOf(t),o=this.allAnnotations.indexOf(e);if(o<l){let n=o;o=l,l=n}for(let n=l+1;n<o;n++)this.allAnnotations[n].dismissed&&(this.allAnnotations[n].newLabel=i)},enableForceChange(){this.forceChange=!0},disableForceChange(){this.forceChange=!1},packDismissedToSave(t){let e={};for(let i=t.length-1;i>=0;i--)e.hasOwnProperty(t[i].label_id)?e[t[i].label_id].push(t[i].id):e[t[i].label_id]=[t[i].id];return e},packChangedToSave(t){let e={};for(let i=t.length-1;i>=0;i--)e.hasOwnProperty(t[i].newLabel.id)?e[t[i].newLabel.id].push(t[i].id):e[t[i].newLabel.id]=[t[i].id];return e},initializeEcho(){Q.getInstance().private(`user-${this.user.id}`).listen(".Biigle\\Modules\\Largo\\Events\\LargoSessionSaved",this.handleSessionSaved).listen(".Biigle\\Modules\\Largo\\Events\\LargoSessionFailed",this.handleSessionFailed)},updateShowOutlines(t){this.showAnnotationOutlines=t},updateSortDirection(t){this.sortingDirection=t},fetchSortingSequence(t,e){var o,n;const i=(n=(o=this.sortingSequenceCache)==null?void 0:o[e])==null?void 0:n[t];if(i)return Promise.resolve(i);let l;if(!this.selectedLabel)l=Promise.resolve([]);else if(t===h.OUTLIER)l=this.querySortByOutlier(e).then(s=>s.body);else{if(t===h.SIMILARITY)return this.querySortBySimilarity(e,this.similarityReference).then(s=>s.body);l=Promise.resolve([])}return l.then(s=>this.putSortingSequenceToCache(t,e,s))},putSortingSequenceToCache(t,e,i){return this.sortingSequenceCache[e]||(this.sortingSequenceCache[e]={}),this.sortingSequenceCache[e][t]=i,i},updateSortKey(t){var i;t!==h.SIMILARITY&&(this.similarityReference=null,this.pinnedImage=null);const e=(i=this.selectedLabel)==null?void 0:i.id;return this.startLoading(),this.fetchSortingSequence(t,e).then(l=>{this.sortingKey=t,this.sortingSequence=l,t===h.SIMILARITY&&(this.needsSimilarityReference=!1,this.pinnedImage=this.similarityReference)}).catch(l=>{this.handleErrorResponse(l),this.similarityReference=null}).finally(this.finishLoading)},handleInitSimilaritySort(){this.sortingKey!==h.SIMILARITY&&(this.needsSimilarityReference=!0)},handleCancelSimilaritySort(){this.needsSimilarityReference=!1},handlePinImage(t){var e;((e=this.pinnedImage)==null?void 0:e.id)===t.id?this.resetSorting():this.imagesPinnable&&(this.similarityReference=t,this.updateSortKey(h.SIMILARITY))},resetSorting(){return this.updateSortKey(h.ANNOTATION_ID).then(()=>this.sortingDirection=y.DESCENDING)},handleOpenTab(t){t==="label-list"&&!this.fetchedLabelCount&&this.getLabelCount()},getLabelCount(){this.startLoading(),this.fetchLabelCount().then(this.parseResponse).catch(E).finally(this.finishLoading)},parseResponse(t){this.labels=t.body.reduce((e,i)=>{if(this.labelTreesIndex.hasOwnProperty(i.label_tree_id)){let l=this.labelTreesIndex[i.label_tree_id].index,o=this.labelTreesIndex[i.label_tree_id].labels[i.id],n=this.labelTrees[l].labels[o];n.count=i.count,e.push(n)}else i.selected=!1,e.push(i);return e},[]),this.fetchedLabelCount=!0},resetLabelCount(){this.fetchedLabelCount=!1,this.labels=[]},resetFilteringTab(){this.activeFilters=[]},addNewFilter(t){this.activeFilters.length>0&&this.activeFilters.some(e=>e.filter===t.filter&&e.value===t.value)||this.activeFilters.push(t)},setUnionLogic(t){this.union=t}},watch:{annotationsCount(t){v.emit("annotations-count",t)},dismissedAnnotationsCount(t){v.emit("dismissed-annotations-count",t)},step(t){v.emit("step",t)},selectedLabel(t,e){this.isInDismissStep&&this.$refs.dismissGrid.setOffset(0),e!=null&&e.selected&&(e.selected=!1)},union(){this.handleSelectedFilters()},activeFilters:{deep:!0,handler(){this.isInDismissStep&&this.handleSelectedFilters()}}},created(){this.user=biigle.$require("largo.user"),window.addEventListener("beforeunload",t=>{if(this.hasDismissedAnnotations)return t.preventDefault(),t.returnValue="","This page is asking you to confirm that you want to leave - data you have entered may not be saved."}),this.initializeEcho()}},Zt={mixins:[B],components:{catalogImageGrid:Le},data(){return{labelTrees:[]}},methods:{queryAnnotations(t){let e=G.queryImageAnnotations({id:t.id}),i=G.queryVideoAnnotations({id:t.id});return Promise.all([e,i])},showOutlines(){this.showAnnotationOutlines=!0},hideOutlines(){this.showAnnotationOutlines=!1}},created(){let t=biigle.$require("annotationCatalog.labelTree");this.labelTrees=[t],this.showAnnotationOutlines=!1}},Xt={mixins:[B],data(){return{volumeId:null,labelTrees:[],mediaType:""}},methods:{queryAnnotations(t,e=[]){let i,l,o={...e,id:this.volumeId,label_id:t.id};return this.mediaType==="image"?(i=p.queryImageAnnotations(o),l=Promise.resolve([])):(i=Promise.resolve([]),l=p.queryVideoAnnotations(o)),Promise.all([i,l])},performSave(t){return p.save({id:this.volumeId},t)},querySortByOutlier(t){return p.sortAnnotationsByOutlier({id:this.volumeId,label_id:t}).then(this.parseSortingQuery)},querySortBySimilarity(t,e){return p.sortAnnotationsBySimilarity({id:this.volumeId,label_id:t,annotation_id:e.id}).then(this.parseSortingQuery)},parseSortingQuery(t){return this.mediaType==="image"?t.body=t.body.map(e=>"i"+e):t.body=t.body.map(e=>"v"+e),t},fetchLabelCount(){return p.fetchVolumeAnnotationLabelCount({id:this.volumeId})}},created(){this.volumeId=biigle.$require("largo.volumeId"),this.labelTrees=biigle.$require("largo.labelTrees"),this.mediaType=biigle.$require("largo.mediaType")}},ei={data(){return{step:0,count:0,dismissedCount:0}},computed:{shownCount(){return this.isInDismissStep?this.count:this.dismissedCount},isInDismissStep(){return this.step===0},isInRelabelStep(){return this.step===1}},methods:{updateStep(t){this.step=t},updateCount(t){this.count=t},updateDismissedCount(t){this.dismissedCount=t}},created(){v.on("annotations-count",this.updateCount),v.on("dismissed-annotations-count",this.updateDismissedCount),v.on("step",this.updateStep)}},ti={mixins:[B],data(){return{projectId:null,labelTrees:[]}},methods:{queryAnnotations(t,e=[]){let i={...e,id:this.projectId,label_id:t.id},l=S.queryImageAnnotations(i),o=S.queryVideoAnnotations(i);return Promise.all([l,o])},performSave(t){return S.save({id:this.projectId},t)},querySortByOutlier(t){return S.sortAnnotationsByOutlier({id:this.projectId,label_id:t})},querySortBySimilarity(t,e){let i={id:this.projectId,label_id:t};return e.type===A?i.image_annotation_id=e.id:i.video_annotation_id=e.id,S.sortAnnotationsBySimilarity(i)},fetchLabelCount(){return S.fetchProjectAnnotationLabelCount({id:this.projectId})}},created(){this.projectId=biigle.$require("largo.projectId"),this.labelTrees=biigle.$require("largo.labelTrees")}};biigle.$mount("annotation-catalog-container",Zt);biigle.$mount("largo-container",Xt);biigle.$mount("largo-title",ei);biigle.$mount("project-largo-container",ti);
