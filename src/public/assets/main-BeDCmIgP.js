import{createElementBlock as d,openBlock as r,resolveComponent as _,createCommentVNode as m,createTextVNode as u,createElementVNode as l,toDisplayString as A,Fragment as G,renderList as j,createBlock as K,createVNode as U,withCtx as V,normalizeClass as c,withDirectives as O,vShow as T,normalizeStyle as M,withModifiers as k}from"vue";const f="imageAnnotation",v="videoAnnotation",I={computed:{id(){return this.image.id},uuid(){return this.image.uuid},type(){return this.image.type},patchPrefix(){return this.uuid[0]+this.uuid[1]+"/"+this.uuid[2]+this.uuid[3]+"/"+this.uuid},urlTemplate(){return biigle.$require("largo.patchUrlTemplate")}},methods:{getThumbnailUrl(){return this.type===v?this.urlTemplate.replace(":prefix",this.patchPrefix).replace(":id",`v-${this.id}`):this.urlTemplate.replace(":prefix",this.patchPrefix).replace(":id",this.id)}},created(){this.type===f?this.showAnnotationRoute=biigle.$require("largo.showImageAnnotationRoute"):this.showAnnotationRoute=biigle.$require("largo.showVideoAnnotationRoute")}},g=(e,t)=>{const i=e.__vccOpts||e;for(const[a,o]of t)i[a]=o;return i},z={mixins:[I],props:{_id:{type:String,required:!0},_uuid:{type:String,required:!0},label:{type:Object,required:!0},emptySrc:{type:String,required:!0},_urlTemplate:{type:String,required:!0}},data(){return{url:""}},computed:{title(){return"Example annotation for label "+this.label.name},src(){return this.url||this.emptySrc},image(){return{id:this._id,uuid:this._uuid,type:f}},urlTemplate(){return this._urlTemplate}},methods:{showEmptyImage(){this.url=""}},created(){this.url=this.getThumbnailUrl()}},F=["src","title"];function H(e,t,i,a,o,n){return r(),d("img",{class:"largo-example-annotation",src:n.src,title:n.title,onError:t[0]||(t[0]=(...s)=>n.showEmptyImage&&n.showEmptyImage(...s))},null,40,F)}const W=g(z,[["render",H]]);let Q=biigle.$require("echo"),p=biigle.$require("events"),L=biigle.$require("messages").handleErrorResponse,C=biigle.$require("volumes.components.imageGrid"),E=biigle.$require("volumes.components.imageGridImage"),Z=biigle.$require("core.keyboard"),R=biigle.$require("annotations.components.labelsTabPlugins"),J=biigle.$require("labelTrees.components.labelTrees"),Y=biigle.$require("core.mixins.loader"),N=biigle.$require("messages"),q=biigle.$require("core.components.powerToggle"),x=biigle.$require("resource"),X=biigle.$require("core.models.Settings"),P=biigle.$require("annotations.components.settingsTabPlugins"),ee=biigle.$require("core.components.sidebar"),te=biigle.$require("core.components.sidebarTab");const y=x("api/v1/volumes{/id}/largo",{},{queryImageAnnotations:{method:"GET",url:"api/v1/volumes{/id}/image-annotations/filter/label{/label_id}"},queryVideoAnnotations:{method:"GET",url:"api/v1/volumes{/id}/video-annotations/filter/label{/label_id}"},queryExampleAnnotations:{method:"GET",url:"api/v1/volumes{/id}/image-annotations/examples{/label_id}"},sortAnnotationsByOutlier:{method:"GET",url:"api/v1/volumes{/id}/annotations/sort/outliers{/label_id}"},sortAnnotationsBySimilarity:{method:"GET",url:"api/v1/volumes{/id}/annotations/sort/similarity"},fetchVolumeAnnotationLabelCount:{method:"GET",url:"api/v1/volume{/id}/label-count"}}),ie={mixins:[Y],components:{annotationPatch:W},props:{label:{default:null},volumeId:{type:Number,required:!0},count:{type:Number,default:3},emptySrc:{type:String,required:!0},urlTemplate:{type:String,required:!0}},data(){return{exampleLabel:null,exampleAnnotations:[],cache:{},shown:!0}},computed:{isShown(){return this.shown&&this.label!==null},hasExamples(){return this.exampleLabel&&this.exampleAnnotations&&Object.keys(this.exampleAnnotations).length>0}},methods:{parseResponse(e){return e.data},setExampleAnnotations(e){(!e[0].hasOwnProperty("annotations")||Object.keys(e[0].annotations).length<this.count)&&delete this.cache[e[1]],(!e[0].hasOwnProperty("label")||e[0].label.id!==e[1])&&delete this.cache[e[1]],this.label&&this.label.id===e[1]&&(this.exampleAnnotations=e[0].annotations,this.exampleLabel=e[0].label)},updateShown(e){this.shown=e},updateExampleAnnotations(){this.exampleAnnotations=[],this.isShown&&(this.startLoading(),this.cache.hasOwnProperty(this.label.id)||(this.cache[this.label.id]=y.queryExampleAnnotations({id:this.volumeId,label_id:this.label.id,take:this.count}).then(this.parseResponse)),Promise.all([this.cache[this.label.id],this.label.id]).then(this.setExampleAnnotations).finally(this.finishLoading))}},watch:{label(){this.updateExampleAnnotations()},shown(){this.updateExampleAnnotations()}},created(){p.on("settings.exampleAnnotations",this.updateShown)}},ne={key:0,class:"largo-example-annotations"},se={key:0,class:"text-muted"},oe={key:1},ae={key:0},le={key:0,class:"text-muted"},re=["textContent"],de=["textContent"],ue={class:"largo-example-annotations__images"},he={key:1,class:"text-muted"};function me(e,t,i,a,o,n){const s=_("annotation-patch");return n.isShown?(r(),d("div",ne,[e.loading?(r(),d("p",se,`
        Loading example annotations...
    `)):(r(),d("div",oe,[n.hasExamples?(r(),d("div",ae,[i.label.id!==o.exampleLabel.id?(r(),d("p",le,[t[0]||(t[0]=u(`
                Examples with label `)),l("strong",{textContent:A(o.exampleLabel.name)},null,8,re),t[1]||(t[1]=u(", may be similar to ")),l("strong",{textContent:A(i.label.name)},null,8,de),t[2]||(t[2]=u(`:
            `))])):m("",!0),t[3]||(t[3]=u()),l("div",ue,[(r(!0),d(G,null,j(o.exampleAnnotations,(w,D)=>(r(),K(s,{key:D,_id:D,_uuid:w,label:i.label,"empty-src":i.emptySrc,"_url-template":i.urlTemplate},null,8,["_id","_uuid","label","empty-src","_url-template"]))),128))])])):(r(),d("p",he,`
            No example annotations available.
        `))]))])):m("",!0)}const ce=g(ie,[["render",me]]);R&&(R.exampleAnnotations=ce);const ge={components:{powerButton:q},props:{settings:{type:Object,required:!0}},data(){return{isShown:!0}},methods:{hide(){this.isShown=!1,this.settings.set("exampleAnnotations",!1)},show(){this.isShown=!0,this.settings.delete("exampleAnnotations")}},watch:{isShown(e){p.emit("settings.exampleAnnotations",e)}},created(){this.settings.has("exampleAnnotations")&&(this.isShown=this.settings.get("exampleAnnotations"))}},be={class:"sidebar-tab__section"};function pe(e,t,i,a,o,n){const s=_("power-button");return r(),d("div",be,[U(s,{active:o.isShown,"title-off":"Show example annotations","title-on":"Hide example annotations",onOn:n.show,onOff:n.hide},{default:V(()=>t[0]||(t[0]=[u(`
                Example Annotations
            `)])),_:1},8,["active","onOn","onOff"])])}const ye=g(ge,[["render",pe]]);P&&(P.exampleAnnotations=ye);biigle.$declare("largo.mixins.annotationPatch",I);const fe={mixins:[E,I],data(){return{showAnnotationRoute:null,overlayIsLoaded:!1,overlayHasError:!1}},inject:["outlines"],computed:{showAnnotationLink(){return this.showAnnotationRoute?this.showAnnotationRoute+this.image.id:""},svgSrcUrl(){return this.srcUrl.replace(/.[A-Za-z]*$/,".svg")},showOutlines(){return!this.overlayHasError&&this.outlines.showAnnotationOutlines}},methods:{handleOverlayLoad(){this.overlayIsLoaded=!0},handleOverlayError(){this.overlayHasError=!0}},created(){this.type===f?this.showAnnotationRoute=biigle.$require("annotationCatalog.showImageAnnotationRoute"):this.showAnnotationRoute=biigle.$require("annotationCatalog.showVideoAnnotationRoute")}},Se=["href"],Ae=["src"],ve=["src"],Ie=["src"];function we(e,t,i,a,o,n){return r(),d("figure",{class:c(["image-grid__image image-grid__image--catalog",e.classObject])},[n.showAnnotationLink?(r(),d("a",{key:0,href:n.showAnnotationLink,target:"_blank",title:"Show the annotation in the annotation tool"},[l("img",{src:e.srcUrl,onError:t[0]||(t[0]=(...s)=>e.showEmptyImage&&e.showEmptyImage(...s))},null,40,Ae),t[4]||(t[4]=u()),this.showOutlines?O((r(),d("img",{key:0,src:n.svgSrcUrl,onError:t[1]||(t[1]=(...s)=>n.handleOverlayError&&n.handleOverlayError(...s)),onLoad:t[2]||(t[2]=(...s)=>n.handleOverlayLoad&&n.handleOverlayLoad(...s)),class:"outlines"},null,40,ve)),[[T,o.overlayIsLoaded]]):m("",!0)],8,Se)):(r(),d("img",{key:1,src:e.srcUrl,onError:t[3]||(t[3]=(...s)=>e.showEmptyImage&&e.showEmptyImage(...s))},null,40,Ie))],2)}const _e=g(fe,[["render",we]]),Le={mixins:[C],components:{imageGridImage:_e}},B=x("api/v1/labels{/id}",{},{queryImageAnnotations:{method:"GET",url:"api/v1/labels{/id}/image-annotations"},queryVideoAnnotations:{method:"GET",url:"api/v1/labels{/id}/video-annotations"}}),Oe={mixins:[E,I],data(){return{showAnnotationRoute:null,overlayIsLoaded:!1,overlayHasError:!1}},inject:["outlines"],computed:{showAnnotationLink(){return this.showAnnotationRoute?this.showAnnotationRoute+this.image.id:""},selected(){return this.image.dismissed},title(){return this.selected?"Undo dismissing this annotation":"Dismiss this annotation"},pinTitle(){return this.isPinned?"Reset sorting":"Select as reference (sort by similarity)"},svgSrcUrl(){return this.srcUrl.replace(/.[A-Za-z]*$/,".svg")},showAnnotationOutlines(){return!this.overlayHasError&&this.outlines.showAnnotationOutlines}},methods:{handleOverlayLoad(){this.overlayIsLoaded=!0},handleOverlayError(){this.overlayHasError=!0}}},Te=["title"],Ce={key:0,class:"image-icon"},Ee=["src"],qe=["src"],xe={key:2,class:"image-buttons-bottom"},$e=["title"],De={key:3,class:"image-buttons"},ke=["href"];function Re(e,t,i,a,o,n){return r(),d("figure",{class:c(["image-grid__image image-grid__image--largo",e.classObject]),title:n.title},[e.selectable?(r(),d("div",Ce,[l("i",{class:c(["fas",e.iconClass])},null,2)])):m("",!0),t[7]||(t[7]=u()),l("img",{src:e.srcUrl,onError:t[0]||(t[0]=(...s)=>e.showEmptyImage&&e.showEmptyImage(...s)),onClick:t[1]||(t[1]=(...s)=>e.toggleSelect&&e.toggleSelect(...s))},null,40,Ee),t[8]||(t[8]=u()),this.showAnnotationOutlines?O((r(),d("img",{key:1,src:n.svgSrcUrl,onError:t[2]||(t[2]=(...s)=>n.handleOverlayError&&n.handleOverlayError(...s)),onLoad:t[3]||(t[3]=(...s)=>n.handleOverlayLoad&&n.handleOverlayLoad(...s)),class:"outlines"},null,40,qe)),[[T,o.overlayIsLoaded]]):m("",!0),t[9]||(t[9]=u()),e.pinnable||e.isPinned?(r(),d("div",xe,[l("button",{class:"image-button image-button__pin",onClick:t[4]||(t[4]=(...s)=>e.emitPin&&e.emitPin(...s)),title:n.pinTitle},t[5]||(t[5]=[l("span",{class:"fa fa-thumbtack fa-fw"},null,-1)]),8,$e)])):m("",!0),t[10]||(t[10]=u()),n.showAnnotationLink?(r(),d("div",De,[l("a",{href:n.showAnnotationLink,target:"_blank",class:"image-button",title:"Show the annotation in the annotation tool"},t[6]||(t[6]=[l("span",{class:"fa fa-external-link-square-alt fa-fw","aria-hidden":"true"},null,-1)]),8,ke)])):m("",!0)],10,Te)}const Ne=g(Oe,[["render",Re]]),Pe={mixins:[C],components:{imageGridImage:Ne}},Be={mixins:[E,I],data(){return{showAnnotationRoute:null,overlayIsLoaded:!1,overlayHasError:!1}},inject:["outlines"],computed:{showAnnotationLink(){return this.showAnnotationRoute?this.showAnnotationRoute+this.image.id:""},selected(){return this.image.newLabel},title(){return this.selected?"Revert changing the label of this annotation":"Change the label of this annotation"},newLabelStyle(){return{"background-color":"#"+this.image.newLabel.color}},svgSrcUrl(){return this.srcUrl.replace(/.[A-Za-z]*$/,".svg")},showAnnotationOutlines(){return!this.overlayHasError&&this.outlines.showAnnotationOutlines}},methods:{handleOverlayLoad(){this.overlayIsLoaded=!0},handleOverlayError(){this.overlayHasError=!0}}},Ge=["title"],je={key:0,class:"image-icon"},Ke=["src"],Ue=["src"],Ve={key:2,class:"image-buttons"},Me=["href"],Ye={key:3,class:"new-label"},ze=["textContent"];function Fe(e,t,i,a,o,n){return r(),d("figure",{class:c(["image-grid__image image-grid__image--largo image-grid__image--relabel",e.classObject]),title:n.title},[e.selectable?(r(),d("div",je,[l("i",{class:c(["fas",e.iconClass])},null,2)])):m("",!0),t[6]||(t[6]=u()),l("img",{onClick:t[0]||(t[0]=(...s)=>e.toggleSelect&&e.toggleSelect(...s)),src:e.srcUrl,onError:t[1]||(t[1]=(...s)=>e.showEmptyImage&&e.showEmptyImage(...s))},null,40,Ke),t[7]||(t[7]=u()),this.showAnnotationOutlines?O((r(),d("img",{key:1,src:n.svgSrcUrl,onError:t[2]||(t[2]=(...s)=>n.handleOverlayError&&n.handleOverlayError(...s)),onLoad:t[3]||(t[3]=(...s)=>n.handleOverlayLoad&&n.handleOverlayLoad(...s)),class:"outlines"},null,40,Ue)),[[T,o.overlayIsLoaded]]):m("",!0),t[8]||(t[8]=u()),n.showAnnotationLink?(r(),d("div",Ve,[l("a",{href:n.showAnnotationLink,target:"_blank",class:"image-button",title:"Show the annotation in the annotation tool"},t[4]||(t[4]=[l("span",{class:"fa fa-external-link-square-alt","aria-hidden":"true"},null,-1)]),8,Me)])):m("",!0),t[9]||(t[9]=u()),n.selected?(r(),d("div",Ye,[l("span",{class:"new-label__color",style:M(n.newLabelStyle)},null,4),t[5]||(t[5]=u()),l("span",{class:"new-label__name",textContent:A(e.image.newLabel.name)},null,8,ze)])):m("",!0)],10,Ge)}const He=g(Be,[["render",Fe]]),We={mixins:[C],components:{imageGridImage:He}};let Qe={showOutlines:!0};const Ze=new X({storageKey:"biigle.largo.settings",defaults:Qe}),Je={emits:["change-outlines"],components:{PowerToggle:q},data(){return{restoreKeys:["showOutlines"],showOutlines:!0}},computed:{settings(){return Ze}},methods:{enableOutlines(){this.showOutlines=!0},disableOutlines(){this.showOutlines=!1}},watch:{showOutlines(e){this.$emit("change-outlines",e),this.settings.set("showOutlines",e)}},created(){this.restoreKeys.forEach(e=>{this[e]=this.settings.get(e)}),Z.on("o",()=>{this.showOutlines?this.disableOutlines():this.enableOutlines()})}},Xe={class:"settings-tab"},et={class:"largo-tab__button"};function tt(e,t,i,a,o,n){const s=_("power-toggle");return r(),d("div",Xe,[l("div",et,[U(s,{active:o.showOutlines,onOn:n.enableOutlines,onOff:n.disableOutlines},{default:V(()=>t[0]||(t[0]=[u(`
                Show annotation outlines
            `)])),_:1},8,["active","onOn","onOff"])])])}const it=g(Je,[["render",tt]]),b={ASCENDING:0,DESCENDING:1},h={ANNOTATION_ID:0,OUTLIER:1,SIMILARITY:2},nt={emits:["change-direction","change-key","init-similarity","cancel-similarity"],props:{sortKey:{type:Number,required:!0},sortDirection:{type:Number,required:!0},needsSimilarityReference:{type:Boolean,default:!1}},computed:{sortedAscending(){return this.sortDirection===b.ASCENDING},sortedDescending(){return this.sortDirection===b.DESCENDING},sortingByAnnotationId(){return this.sortKey===h.ANNOTATION_ID},sortingByOutlier(){return this.sortKey===h.OUTLIER},sortingBySimilarity(){return this.sortKey===h.SIMILARITY}},methods:{sortAscending(){this.$emit("change-direction",b.ASCENDING)},sortDescending(){this.$emit("change-direction",b.DESCENDING)},reset(){this.sortDescending(),this.sortByAnnotationId()},sortByAnnotationId(){this.$emit("change-key",h.ANNOTATION_ID),this.needsSimilarityReference&&this.cancelSortBySimilarity()},sortByOutlier(){this.$emit("change-key",h.OUTLIER),this.needsSimilarityReference&&this.cancelSortBySimilarity()},initializeSortBySimilarity(){this.$emit("init-similarity")},cancelSortBySimilarity(){this.$emit("cancel-similarity")}}},st={class:"sorting-tab"},ot={class:"sorting-tab__buttons"},at={class:"btn-group",role:"group"},lt={class:"btn-group pull-right",role:"group"},rt={class:"list-group sorter-list-group"},dt={key:1};function ut(e,t,i,a,o,n){return r(),d("div",st,[l("div",ot,[l("div",at,[l("button",{type:"button",class:c(["btn btn-default",{active:n.sortedDescending}]),title:"Sort descending",onClick:t[0]||(t[0]=(...s)=>n.sortDescending&&n.sortDescending(...s))},t[7]||(t[7]=[l("span",{class:"fa fa-sort-amount-down"},null,-1)]),2),t[9]||(t[9]=u()),l("button",{type:"button",class:c(["btn btn-default",{active:n.sortedAscending}]),title:"Sort ascending",onClick:t[1]||(t[1]=(...s)=>n.sortAscending&&n.sortAscending(...s))},t[8]||(t[8]=[l("span",{class:"fa fa-sort-amount-up"},null,-1)]),2)]),t[11]||(t[11]=u()),l("div",lt,[l("button",{type:"button",class:"btn btn-default",title:"Reset sorting",onClick:t[2]||(t[2]=(...s)=>n.reset&&n.reset(...s))},t[10]||(t[10]=[l("span",{class:"fa fa-times"},null,-1)]))])]),t[17]||(t[17]=u()),l("div",rt,[l("button",{class:c(["list-group-item",{active:n.sortingByAnnotationId}]),title:"Sort by annotation timestamp (higher is newer)",onClick:t[3]||(t[3]=(...s)=>n.sortByAnnotationId&&n.sortByAnnotationId(...s))},`
                Created
            `,2),t[15]||(t[15]=u()),l("button",{class:c(["list-group-item",{active:n.sortingByOutlier}]),title:"Sort by outliers (higher is more dissimilar)",onClick:t[4]||(t[4]=(...s)=>n.sortByOutlier&&n.sortByOutlier(...s))},`
                Outliers
            `,2),t[16]||(t[16]=u()),l("a",{class:c(["list-group-item",{active:n.sortingBySimilarity,"list-group-item-warning":i.needsSimilarityReference}]),title:"Sort by similarity (higher is more similar)",href:"#",onClick:t[6]||(t[6]=k((...s)=>n.initializeSortBySimilarity&&n.initializeSortBySimilarity(...s),["prevent"]))},[i.needsSimilarityReference?(r(),d("button",{key:0,class:"btn btn-default btn-xs pull-right",title:"Cancel selecting a reference annotation",onClick:t[5]||(t[5]=k((...s)=>n.cancelSortBySimilarity&&n.cancelSortBySimilarity(...s),["stop"]))},t[12]||(t[12]=[l("i",{class:"fa fa-undo"},null,-1)]))):m("",!0),t[14]||(t[14]=u(`
                Similarity
                `)),i.needsSimilarityReference?(r(),d("p",dt,t[13]||(t[13]=[u(`
                    Select a reference annotation with a click on the `),l("i",{class:"fa fa-thumbtack fa-fw"},null,-1),u(` button.
                `)]))):m("",!0)],2)])])}const ht=g(nt,[["render",ut]]),mt={emits:["select","deselect"],props:{label:{type:Object,default(){return{}}}},computed:{title(){return`Annotations with label ${this.label.name}`},classObject(){return{selected:this.label.selected}},countTitle(){return`There are ${this.count} annotations with label ${this.label.name}`},colorStyle(){return"background-color: #"+this.label.color},count(){return this.label.count}},methods:{emitSelectLabel(){this.labelItem.selected=!this.labelItem.selected,this.labelItem.selected?this.$emit("select",this.labelItem):this.$emit("deselect")}},created(){this.labelItem=this.label}},ct=["title"],gt=["textContent","title"],bt=["textContent"];function pt(e,t,i,a,o,n){return r(),d("li",{class:c(["annotations-tab-item--largo",n.classObject]),title:n.title},[l("div",{class:"annotations-tab-item__title--largo",onClick:t[0]||(t[0]=(...s)=>n.emitSelectLabel&&n.emitSelectLabel(...s))},[l("span",{class:"pull-right badge",textContent:A(n.count),title:n.countTitle},null,8,gt),t[1]||(t[1]=u()),l("span",{class:"annotations-tab-item__color--largo",style:M(n.colorStyle)},null,4),t[2]||(t[2]=u()),l("span",{textContent:A(i.label.name)},null,8,bt)])],10,ct)}const yt=g(mt,[["render",pt]]),ft={emits:["select","deselect"],components:{labelItem:yt},props:{labels:{type:Array,default(){return[]}}},computed:{annotationBadgeCount(){return this.labels.reduce((e,t)=>e+t.count,0)}},methods:{handleSelectedLabel(e){this.$emit("select",e)},handleDeselectedLabel(){this.$emit("deselect")}}},St={class:"annotations-tab--largo"},At={class:"annotations-tab__header--largo"},vt={class:"text-muted"},It=["textContent"],wt={class:"annotations-tab__list--largo list-unstyled",ref:"scrollList"};function _t(e,t,i,a,o,n){const s=_("label-item");return r(),d("div",St,[l("div",At,[l("div",vt,[t[0]||(t[0]=u(`Total
                `)),l("span",{class:"pull-right badge",textContent:A(n.annotationBadgeCount)},null,8,It)])]),t[1]||(t[1]=u()),l("ul",wt,[(r(!0),d(G,null,j(i.labels,w=>(r(),K(s,{key:w.id,label:w,onSelect:n.handleSelectedLabel,onDeselect:n.handleDeselectedLabel},null,8,["label","onSelect","onDeselect"]))),128))],512)])}const Lt=g(ft,[["render",_t]]),$={mixins:[Y],components:{labelTrees:J,sidebar:ee,sidebarTab:te,powerToggle:q,dismissImageGrid:Pe,relabelImageGrid:We,settingsTab:it,sortingTab:ht,labelList:Lt},data(){return{user:null,labelTrees:[],step:0,selectedLabel:null,annotationsCache:{},lastSelectedImage:null,forceChange:!1,waitForSessionId:null,showAnnotationOutlines:!0,sortingSequenceCache:{},sortingSequence:[],sortingDirection:b.DESCENDING,sortingKey:h.ANNOTATION_ID,needsSimilarityReference:!1,similarityReference:null,pinnedImage:null,labels:[],fetchedLabelCount:!1}},provide(){const e={};return Object.defineProperty(e,"showAnnotationOutlines",{get:()=>this.showAnnotationOutlines}),{outlines:e}},computed:{isInDismissStep(){return this.step===0},isInRelabelStep(){return this.step===1},annotations(){return this.selectedLabel&&this.annotationsCache.hasOwnProperty(this.selectedLabel.id)?this.annotationsCache[this.selectedLabel.id]:[]},annotationsCount(){return this.annotations.length},sortedAnnotations(){let e=this.annotations;if(e.length===0)return e;if(this.sortingKey!==h.ANNOTATION_ID){const t={};e.forEach(i=>{t[i.type===v?"v"+i.id:"i"+i.id]=i}),e=this.sortingSequence.map(i=>t[i])}return this.sortingDirection===b.ASCENDING?e.slice().reverse():e},allAnnotations(){let e=[];for(let t in this.annotationsCache)this.annotationsCache.hasOwnProperty(t)&&(e=e.concat(this.annotationsCache[t]));return e},hasNoAnnotations(){return this.selectedLabel&&!this.loading&&this.annotations.length===0},dismissedAnnotations(){return this.allAnnotations.filter(e=>e.dismissed)},dismissedAnnotationsCount(){return this.dismissedAnnotations.length},annotationsWithNewLabel(){return this.dismissedAnnotations.filter(e=>!!e.newLabel)},hasDismissedAnnotations(){return this.dismissedAnnotations.length>0},dismissedImageAnnotationsToSave(){return this.packDismissedToSave(this.dismissedAnnotations.filter(e=>e.type===f))},dismissedVideoAnnotationsToSave(){return this.packDismissedToSave(this.dismissedAnnotations.filter(e=>e.type===v))},changedImageAnnotationsToSave(){return this.packChangedToSave(this.annotationsWithNewLabel.filter(e=>e.type===f))},changedVideoAnnotationsToSave(){return this.packChangedToSave(this.annotationsWithNewLabel.filter(e=>e.type===v))},toDeleteCount(){return this.dismissedAnnotations.length-this.annotationsWithNewLabel.length},saveButtonClass(){return this.forceChange?"btn-danger":"btn-success"},sortingIsActive(){return this.isInDismissStep&&(this.sortingKey!==h.ANNOTATION_ID||this.sortingDirection!==b.DESCENDING)},imagesPinnable(){return this.needsSimilarityReference||this.sortingKey===h.SIMILARITY},labelTreesIndex(){let e={};return this.labelTrees.forEach((t,i)=>{e[t.id]={index:i,labels:{}},t.labels.forEach((a,o)=>{e[t.id].labels[a.id]=o})}),e}},methods:{getAnnotations(e){let t,i;this.annotationsCache.hasOwnProperty(e.id)?t=Promise.resolve():(this.annotationsCache[e.id]=[],this.startLoading(),t=this.queryAnnotations(e).then(a=>this.gotAnnotations(e,a),L)),this.sortingKey===h.SIMILARITY?i=this.resetSorting():this.sortingIsActive?(this.sortingSequence=[],i=this.updateSortKey(this.sortingKey)):i=Promise.resolve(),Promise.all([t,i]).finally(this.finishLoading)},gotAnnotations(e,t){let i=t[0].data,a=t[1].data,o=[];i&&(o=o.concat(this.initAnnotations(e,i,f))),a&&(o=o.concat(this.initAnnotations(e,a,v))),o=o.sort((n,s)=>s.id-n.id),this.annotationsCache[e.id]=o},initAnnotations(e,t,i){return Object.keys(t).map(function(a){return{id:a,uuid:t[a],label_id:e.id,dismissed:!1,newLabel:null,type:i}})},handleSelectedLabel(e){this.selectedLabel=e,this.isInDismissStep&&this.getAnnotations(e)},handleDeselectedLabel(){this.selectedLabel=null},handleSelectedImageDismiss(e,t){e.dismissed?(e.dismissed=!1,e.newLabel=null):(e.dismissed=!0,t.shiftKey&&this.lastSelectedImage?this.dismissAllImagesBetween(e,this.lastSelectedImage):this.lastSelectedImage=e)},goToRelabel(){this.step=1,this.lastSelectedImage=null},goToDismiss(){this.step=0,this.lastSelectedImage=null,this.selectedLabel&&this.getAnnotations(this.selectedLabel)},handleSelectedImageRelabel(e,t){e.newLabel?this.selectedLabel&&e.newLabel.id!==this.selectedLabel.id?e.newLabel=this.selectedLabel:e.newLabel=null:this.selectedLabel&&(e.newLabel=this.selectedLabel,t.shiftKey&&this.lastSelectedImage?this.relabelAllImagesBetween(e,this.lastSelectedImage):this.lastSelectedImage=e)},save(){if(!this.loading){if(this.toDeleteCount>0){let e;for(;e!==null&&parseInt(e,10)!==this.toDeleteCount;)e=prompt(`This might delete ${this.toDeleteCount} annotation(s). Please enter the number to continue.`);if(e===null)return}this.startLoading(),this.performSave({dismissed_image_annotations:this.dismissedImageAnnotationsToSave,changed_image_annotations:this.changedImageAnnotationsToSave,dismissed_video_annotations:this.dismissedVideoAnnotationsToSave,changed_video_annotations:this.changedVideoAnnotationsToSave,force:this.forceChange}).then(e=>{this.waitForSessionId=e.body.id,this.resetLabelCount()},e=>{this.finishLoading(),L(e)})}},handleSessionSaved(e){if(e.id==this.waitForSessionId){this.finishLoading(),N.success("Saved. You can now start a new re-evaluation session."),this.step=0;for(let t in this.annotationsCache)this.annotationsCache.hasOwnProperty(t)&&delete this.annotationsCache[t];for(let t in this.sortingSequenceCache)this.sortingSequenceCache.hasOwnProperty(t)&&delete this.sortingSequenceCache[t];this.handleSelectedLabel(this.selectedLabel)}},handleSessionFailed(e){e.id==this.waitForSessionId&&(this.finishLoading(),N.danger("There was an unexpected error."))},dismissAllImagesBetween(e,t){let i=this.sortedAnnotations.indexOf(e),a=this.sortedAnnotations.indexOf(t);if(a<i){let o=a;a=i,i=o}for(let o=i+1;o<a;o++)this.sortedAnnotations[o].dismissed=!0},relabelAllImagesBetween(e,t){let i=this.selectedLabel,a=this.allAnnotations.indexOf(e),o=this.allAnnotations.indexOf(t);if(o<a){let n=o;o=a,a=n}for(let n=a+1;n<o;n++)this.allAnnotations[n].dismissed&&(this.allAnnotations[n].newLabel=i)},enableForceChange(){this.forceChange=!0},disableForceChange(){this.forceChange=!1},packDismissedToSave(e){let t={};for(let i=e.length-1;i>=0;i--)t.hasOwnProperty(e[i].label_id)?t[e[i].label_id].push(e[i].id):t[e[i].label_id]=[e[i].id];return t},packChangedToSave(e){let t={};for(let i=e.length-1;i>=0;i--)t.hasOwnProperty(e[i].newLabel.id)?t[e[i].newLabel.id].push(e[i].id):t[e[i].newLabel.id]=[e[i].id];return t},initializeEcho(){Q.getInstance().private(`user-${this.user.id}`).listen(".Biigle\\Modules\\Largo\\Events\\LargoSessionSaved",this.handleSessionSaved).listen(".Biigle\\Modules\\Largo\\Events\\LargoSessionFailed",this.handleSessionFailed)},updateShowOutlines(e){this.showAnnotationOutlines=e},updateSortDirection(e){this.sortingDirection=e},fetchSortingSequence(e,t){var o,n;const i=(n=(o=this.sortingSequenceCache)==null?void 0:o[t])==null?void 0:n[e];if(i)return Promise.resolve(i);let a;if(!this.selectedLabel)a=Promise.resolve([]);else if(e===h.OUTLIER)a=this.querySortByOutlier(t).then(s=>s.body);else{if(e===h.SIMILARITY)return this.querySortBySimilarity(t,this.similarityReference).then(s=>s.body);a=Promise.resolve([])}return a.then(s=>this.putSortingSequenceToCache(e,t,s))},putSortingSequenceToCache(e,t,i){return this.sortingSequenceCache[t]||(this.sortingSequenceCache[t]={}),this.sortingSequenceCache[t][e]=i,i},updateSortKey(e){var i;e!==h.SIMILARITY&&(this.similarityReference=null,this.pinnedImage=null);const t=(i=this.selectedLabel)==null?void 0:i.id;return this.startLoading(),this.fetchSortingSequence(e,t).then(a=>{this.sortingKey=e,this.sortingSequence=a,e===h.SIMILARITY&&(this.needsSimilarityReference=!1,this.pinnedImage=this.similarityReference)}).catch(a=>{this.handleErrorResponse(a),this.similarityReference=null}).finally(this.finishLoading)},handleInitSimilaritySort(){this.sortingKey!==h.SIMILARITY&&(this.needsSimilarityReference=!0)},handleCancelSimilaritySort(){this.needsSimilarityReference=!1},handlePinImage(e){var t;((t=this.pinnedImage)==null?void 0:t.id)===e.id?this.resetSorting():this.imagesPinnable&&(this.similarityReference=e,this.updateSortKey(h.SIMILARITY))},resetSorting(){return this.updateSortKey(h.ANNOTATION_ID).then(()=>this.sortingDirection=b.DESCENDING)},handleOpenTab(e){e==="label-list"&&!this.fetchedLabelCount&&this.getLabelCount()},getLabelCount(){this.startLoading(),this.fetchLabelCount().then(this.parseResponse).catch(L).finally(this.finishLoading)},parseResponse(e){this.labels=e.body.reduce((t,i)=>{if(this.labelTreesIndex.hasOwnProperty(i.label_tree_id)){let a=this.labelTreesIndex[i.label_tree_id].index,o=this.labelTreesIndex[i.label_tree_id].labels[i.id],n=this.labelTrees[a].labels[o];n.count=i.count,t.push(n)}else i.selected=!1,t.push(i);return t},[]),this.fetchedLabelCount=!0},resetLabelCount(){this.fetchedLabelCount=!1,this.labels=[]}},watch:{annotationsCount(e){p.emit("annotations-count",e)},dismissedAnnotationsCount(e){p.emit("dismissed-annotations-count",e)},step(e){p.emit("step",e)},selectedLabel(e,t){this.isInDismissStep&&this.$refs.dismissGrid.setOffset(0),t!=null&&t.selected&&(t.selected=!1)}},created(){this.user=biigle.$require("largo.user"),window.addEventListener("beforeunload",e=>{if(this.hasDismissedAnnotations)return e.preventDefault(),e.returnValue="","This page is asking you to confirm that you want to leave - data you have entered may not be saved."}),this.initializeEcho()}},Ot={mixins:[$],components:{catalogImageGrid:Le},data(){return{labelTrees:[]}},methods:{queryAnnotations(e){let t=B.queryImageAnnotations({id:e.id}),i=B.queryVideoAnnotations({id:e.id});return Promise.all([t,i])},showOutlines(){this.showAnnotationOutlines=!0},hideOutlines(){this.showAnnotationOutlines=!1}},created(){let e=biigle.$require("annotationCatalog.labelTree");this.labelTrees=[e],this.showAnnotationOutlines=!1}},Tt={mixins:[$],data(){return{volumeId:null,labelTrees:[],mediaType:""}},methods:{queryAnnotations(e){let t,i;return this.mediaType==="image"?(t=y.queryImageAnnotations({id:this.volumeId,label_id:e.id}),i=Promise.resolve([])):(t=Promise.resolve([]),i=y.queryVideoAnnotations({id:this.volumeId,label_id:e.id})),Promise.all([t,i])},performSave(e){return y.save({id:this.volumeId},e)},querySortByOutlier(e){return y.sortAnnotationsByOutlier({id:this.volumeId,label_id:e}).then(this.parseSortingQuery)},querySortBySimilarity(e,t){return y.sortAnnotationsBySimilarity({id:this.volumeId,label_id:e,annotation_id:t.id}).then(this.parseSortingQuery)},parseSortingQuery(e){return this.mediaType==="image"?e.body=e.body.map(t=>"i"+t):e.body=e.body.map(t=>"v"+t),e},fetchLabelCount(){return y.fetchVolumeAnnotationLabelCount({id:this.volumeId})}},created(){this.volumeId=biigle.$require("largo.volumeId"),this.labelTrees=biigle.$require("largo.labelTrees"),this.mediaType=biigle.$require("largo.mediaType")}},Ct={data(){return{step:0,count:0,dismissedCount:0}},computed:{shownCount(){return this.isInDismissStep?this.count:this.dismissedCount},isInDismissStep(){return this.step===0},isInRelabelStep(){return this.step===1}},methods:{updateStep(e){this.step=e},updateCount(e){this.count=e},updateDismissedCount(e){this.dismissedCount=e}},created(){p.on("annotations-count",this.updateCount),p.on("dismissed-annotations-count",this.updateDismissedCount),p.on("step",this.updateStep)}},S=x("api/v1/projects{/id}/largo",{},{queryImageAnnotations:{method:"GET",url:"api/v1/projects{/id}/image-annotations/filter/label{/label_id}"},queryVideoAnnotations:{method:"GET",url:"api/v1/projects{/id}/video-annotations/filter/label{/label_id}"},sortAnnotationsByOutlier:{method:"GET",url:"api/v1/projects{/id}/annotations/sort/outliers{/label_id}"},sortAnnotationsBySimilarity:{method:"GET",url:"api/v1/projects{/id}/annotations/sort/similarity"},fetchProjectAnnotationLabelCount:{method:"GET",url:"api/v1/projects{/id}/label-count"}}),Et={mixins:[$],data(){return{projectId:null,labelTrees:[]}},methods:{queryAnnotations(e){let t=S.queryImageAnnotations({id:this.projectId,label_id:e.id}),i=S.queryVideoAnnotations({id:this.projectId,label_id:e.id});return Promise.all([t,i])},performSave(e){return S.save({id:this.projectId},e)},querySortByOutlier(e){return S.sortAnnotationsByOutlier({id:this.projectId,label_id:e})},querySortBySimilarity(e,t){let i={id:this.projectId,label_id:e};return t.type===f?i.image_annotation_id=t.id:i.video_annotation_id=t.id,S.sortAnnotationsBySimilarity(i)},fetchLabelCount(){return S.fetchProjectAnnotationLabelCount({id:this.projectId})}},created(){this.projectId=biigle.$require("largo.projectId"),this.labelTrees=biigle.$require("largo.labelTrees")}};biigle.$mount("annotation-catalog-container",Ot);biigle.$mount("largo-container",Tt);biigle.$mount("largo-title",Ct);biigle.$mount("project-largo-container",Et);
